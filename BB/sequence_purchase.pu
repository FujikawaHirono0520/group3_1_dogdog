@startuml
title 商品の購入 - シーケンス図
skinparam boundaryBackgroundColor #D5E8D4
skinparam controlBackgroundColor  #F8CECC
skinparam entityBackgroundColor   #DAE8FC

hide footbox

actor 顧客
boundary "カート一覧画面" as CartView
boundary "クレジットカード番号入力画面" as CardInputView
boundary "決済完了画面" as CompleteView
control "決済APIを実行" as APIExecution
control "購入後処理" as PostPurchase
entity "決済API" as PaymentAPI
entity "エラーDB" as ErrorDataBase
entity "注文DB" as OrderDataBase
entity "商品DB" as GoodsDataBase
entity "カートDB" as CartDataBase
顧客 -> CartView : 「購入」を選択
activate CartView

CartView -> CardInputView : ログイン状態確認要求()
deactivate CartView
activate CardInputView

顧客 -> CardInputView : クレジットカード番号を入力

CardInputView -> APIExecution : 起動()
deactivate CardInputView
activate APIExecution

APIExecution -> PaymentAPI : 決済リクエスト送信()
activate PaymentAPI

PaymentAPI --> APIExecution : 決済の判定結果


deactivate PaymentAPI
alt 決済失敗 (代替フロー1)

    APIExecution -> ErrorDataBase : エラーメッセージ取得()
    activate ErrorDataBase
    ErrorDataBase --> APIExecution : エラーメッセージ
    deactivate ErrorDataBase
    APIExecution -> CartView : エラーメッセージを表示、カート一覧画面へ遷移()
    activate CartView
    
    CartView --> 顧客 : カート一覧画面表示
    deactivate CartView
end
    APIExecution -> PostPurchase : 起動()
    deactivate APIExecution
    activate PostPurchase
    PostPurchase -> OrderDataBase : 注文情報登録()
    activate OrderDataBase
    OrderDataBase --> PostPurchase : 登録完了
    deactivate OrderDataBase

    PostPurchase -> GoodsDataBase : 在庫数更新()
    activate GoodsDataBase
    GoodsDataBase --> PostPurchase : 更新完了
    deactivate GoodsDataBase

    PostPurchase -> CartDataBase : カートの削除()
    activate CartDataBase
    CartDataBase --> PostPurchase : 削除完了
    deactivate CartDataBase

    PostPurchase -> CompleteView : 決済完了画面遷移
    deactivate PostPurchase
    activate CompleteView
    
    CompleteView --> 顧客 : 決済完了画面表示
    deactivate CompleteView

@enduml