@startuml
title 商品の購入 - シーケンス図
skinparam boundaryBackgroundColor #D5E8D4
skinparam controlBackgroundColor  #F8CECC
skinparam entityBackgroundColor   #DAE8FC

hide footbox

actor 顧客
boundary "カート一覧画面" as CartView
control "ログイン状態の確認" as LoginCheck 
boundary "クレジットカード番号入力画面" as CardInputView
control "決済APIに情報を送信" as PaymentSend
control "決済の成功判定" as PaymentResult
control "注文情報の作成" as CreateOrder
control "在庫数の変更" as ChangeStock
control "カート内のデータクリア" as ClearCart
entity "データベース" as DataBase
boundary "決済完了画面" as CompleteView
顧客 -> CartView : 「購入」を選択
activate CartView

CartView -> LoginCheck : ログイン状態確認要求()
activate LoginCheck
LoginCheck -> CardInputView : ログイン済みのため画面遷移()
deactivate LoginCheck
deactivate CartView
activate CardInputView

顧客 -> CardInputView : クレジットカード番号を入力
CardInputView -> PaymentSend : 決済リクエスト送信()
deactivate CardInputView
activate PaymentSend

PaymentSend -> PaymentResult : 決済の成功、失敗判定を送信()
deactivate PaymentSend
activate PaymentResult
alt 決済失敗 (代替フロー1)
    PaymentResult -> DataBase : 決済失敗情報とエラーコード送信()
    activate DataBase
    

    DataBase -> CartView : エラーメッセージを表示、カート一覧画面へ遷移()
    deactivate DataBase
    activate CartView
    
    CartView --> 顧客 : カート一覧画面表示
    deactivate CartView
end
    PaymentResult -> CreateOrder : 注文情報作成()
    deactivate PaymentResult
    activate CreateOrder
    CreateOrder -> DataBase : 注文情報登録()
    activate DataBase
    DataBase --> CreateOrder : 登録完了

    CreateOrder -> ChangeStock : 在庫数から購入分を引く()
    deactivate CreateOrder
    activate ChangeStock
    ChangeStock -> DataBase : 在庫数更新()
    DataBase --> ChangeStock : 更新完了
    deactivate DataBase
    
    ChangeStock -> ClearCart : カート内商品情報削除()
    deactivate ChangeStock
    activate ClearCart
    ClearCart -> DataBase : カート情報削除()
    activate DataBase
    DataBase --> ClearCart : 削除完了
    deactivate DataBase

    ClearCart -> CompleteView : 決済完了画面遷移
    deactivate ClearCart
    activate CompleteView
    
    CompleteView --> 顧客 : 決済完了画面表示
    deactivate CompleteView

@enduml